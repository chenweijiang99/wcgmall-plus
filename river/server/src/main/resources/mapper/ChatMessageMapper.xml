<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.river.mapper.ChatMessageMapper">

    <!-- 获取消息列表(带发送者信息) -->
    <select id="selectMessageListWithSenderInfo" resultType="com.river.vo.ChatMessageVO">
        SELECT
            m.id,
            m.room_id AS roomId,
            m.sender_id AS senderId,
            m.sender_type AS senderType,
            m.msg_type AS msgType,
            m.content,
            m.media_url AS mediaUrl,
            m.media_duration AS mediaDuration,
            m.media_size AS mediaSize,
            m.thumbnail_url AS thumbnailUrl,
            m.reply_msg_id AS replyMsgId,
            m.is_revoked AS isRevoked,
            m.create_time AS createTime,
            CASE
                WHEN m.sender_type = 1 THEN u.nickname
                WHEN m.sender_type = 2 THEN a.nickname
            END AS senderNickname,
            CASE
                WHEN m.sender_type = 1 THEN u.avatar
                WHEN m.sender_type = 2 THEN a.avatar
            END AS senderAvatar
        FROM chat_message m
        LEFT JOIN sys_user u ON m.sender_type = 1 AND m.sender_id = u.id
        LEFT JOIN sys_user a ON m.sender_type = 2 AND m.sender_id = a.id
        WHERE m.room_id = #{roomId}
        AND m.status = 1
        <if test="lastMsgId != null">
            AND m.id &lt; #{lastMsgId}
        </if>
        ORDER BY m.id DESC
        LIMIT #{pageSize}
    </select>

    <!-- 获取单条消息(带发送者信息) -->
    <select id="selectMessageWithSenderInfo" resultType="com.river.vo.ChatMessageVO">
        SELECT
            m.id,
            m.room_id AS roomId,
            m.sender_id AS senderId,
            m.sender_type AS senderType,
            m.msg_type AS msgType,
            m.content,
            m.media_url AS mediaUrl,
            m.media_duration AS mediaDuration,
            m.media_size AS mediaSize,
            m.thumbnail_url AS thumbnailUrl,
            m.reply_msg_id AS replyMsgId,
            m.is_revoked AS isRevoked,
            m.create_time AS createTime,
            CASE
                WHEN m.sender_type = 1 THEN u.nickname
                WHEN m.sender_type = 2 THEN a.nickname
            END AS senderNickname,
            CASE
                WHEN m.sender_type = 1 THEN u.avatar
                WHEN m.sender_type = 2 THEN a.avatar
            END AS senderAvatar
        FROM chat_message m
        LEFT JOIN sys_user u ON m.sender_type = 1 AND m.sender_id = u.id
        LEFT JOIN sys_user a ON m.sender_type = 2 AND m.sender_id = a.id
        WHERE m.id = #{msgId}
    </select>

</mapper>
