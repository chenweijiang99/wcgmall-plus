<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.river.mapper.ChatRoomMemberMapper">

    <!-- 获取聊天室成员列表(带用户信息) -->
    <select id="selectMemberListWithUserInfo" resultType="com.river.vo.ChatMemberVO">
        SELECT
            m.id,
            m.user_id AS userId,
            m.user_type AS userType,
            m.nickname AS groupNickname,
            m.role,
            m.muted,
            m.join_time AS joinTime,
            CASE
                WHEN m.user_type = 1 THEN u.nickname
                WHEN m.user_type = 2 THEN a.nickname
            END AS nickname,
            CASE
                WHEN m.user_type = 1 THEN u.avatar
                WHEN m.user_type = 2 THEN a.avatar
            END AS avatar
        FROM chat_room_member m
        LEFT JOIN sys_user u ON m.user_type = 1 AND m.user_id = u.id
        LEFT JOIN sys_user a ON m.user_type = 2 AND m.user_id = a.id
        WHERE m.room_id = #{roomId}
        AND m.status = 1
        ORDER BY m.role DESC, m.join_time ASC
    </select>

    <!-- 获取用户所在的所有聊天室ID -->
    <select id="selectRoomIdsByUserId" resultType="java.lang.Long">
        SELECT room_id
        FROM chat_room_member
        WHERE user_id = #{userId}
        AND user_type = #{userType}
        AND status = 1
    </select>

</mapper>
